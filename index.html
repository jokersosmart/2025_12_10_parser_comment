<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾ç¾¤ç•™è¨€ç·¨è¼¯å·¥å…· - å±•ç¤ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .upload-section.dragover {
            border-color: #667eea;
            background: #e3e8ff;
            transform: scale(1.02);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 20px 0;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }
        
        .btn-primary {
            background: #667eea;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #ef4444;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 15px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .stats {
            display: flex;
            gap: 20px;
            background: #f8f9fa;
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .table-container {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: #f8f9fa;
            position: sticky;
            top: 0;
        }
        
        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f5;
        }
        
        tbody tr:hover {
            background: #f8f9fa;
        }
        
        .editable {
            cursor: text;
            min-height: 20px;
        }
        
        .editable:hover {
            background: #fff3cd;
        }
        
        .editable:focus {
            outline: 2px solid #667eea;
            background: white;
        }
        
        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .hidden {
            display: none;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ ç¤¾ç¾¤ç•™è¨€ç·¨è¼¯å·¥å…·</h1>
            <p>ä¸Šå‚³ CSV/Excel æª”æ¡ˆ æˆ– è¼‰å…¥ç¯„ä¾‹è³‡æ–™ - ç«‹å³é–‹å§‹æ•´ç†å’Œåˆ†æç•™è¨€</p>
        </div>
        
        <div class="content">
            <!-- ä¸Šå‚³å€åŸŸ -->
            <div class="upload-section" id="uploadArea">
                <h3 style="margin-bottom: 15px;">ğŸ“ æ‹–æ”¾æª”æ¡ˆåˆ°æ­¤è™• æˆ– é»æ“Šé¸æ“‡æª”æ¡ˆ</h3>
                <p style="color: #6c757d; margin-bottom: 20px;">æ”¯æ´æ ¼å¼ï¼šCSV, Excel (.xlsx), JSON</p>
                <input type="file" id="fileInput" accept=".csv,.xlsx,.xls,.json">
                <div class="button-group">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        ğŸ“‚ é¸æ“‡æª”æ¡ˆ
                    </button>
                    <button class="btn btn-success" onclick="loadSampleData()">
                        âœ¨ è¼‰å…¥ç¯„ä¾‹è³‡æ–™
                    </button>
                    <button class="btn btn-secondary" onclick="showPasteModal()">
                        ğŸ“ æ‰‹å‹•è²¼ä¸Š
                    </button>
                </div>
            </div>
            
            <!-- æç¤ºè¨Šæ¯ -->
            <div id="alertArea"></div>
            
            <!-- çµ±è¨ˆ -->
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-item">
                    <span class="stat-label">ç¸½ç•™è¨€æ•¸</span>
                    <span class="stat-value" id="totalCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">é¡¯ç¤ºä¸­</span>
                    <span class="stat-value" id="displayCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">å·²é¸å–</span>
                    <span class="stat-value" id="selectedCount">0</span>
                </div>
            </div>
            
            <!-- å·¥å…·åˆ— -->
            <div class="toolbar" id="toolbar" style="display: none;">
                <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” æœå°‹ç•™è¨€å…§å®¹...">
                <button class="btn btn-danger" onclick="deleteSelected()">ğŸ—‘ï¸ åˆªé™¤é¸å–</button>
                <button class="btn btn-secondary" onclick="undo()">â†¶ å¾©åŸ</button>
                <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡º Excel</button>
                <button class="btn btn-secondary" onclick="clearAll()">ğŸ”„ æ¸…é™¤å…¨éƒ¨</button>
            </div>
            
            <!-- è¡¨æ ¼ -->
            <div class="table-container" id="tableContainer" style="display: none;">
                <table id="commentsTable">
                    <thead>
                        <tr>
                            <th width="50"><input type="checkbox" class="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                            <th width="150">ç•™è¨€è€…</th>
                            <th>ç•™è¨€å…§å®¹</th>
                            <th width="180">æ™‚é–“</th>
                            <th width="80">æŒ‰è®šæ•¸</th>
                            <th width="100">ä¾†æº</th>
                        </tr>
                    </thead>
                    <tbody id="commentsBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- è²¼ä¸Šè³‡æ–™ Modal -->
    <div class="modal" id="pasteModal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“ è²¼ä¸Šç•™è¨€è³‡æ–™</div>
            <p style="color: #6c757d; margin-bottom: 15px; font-size: 14px;">
                æ”¯æ´ JSON æ ¼å¼æˆ– CSV æ ¼å¼ï¼ˆæ¯è¡Œï¼šç•™è¨€è€…,å…§å®¹,æ™‚é–“,æŒ‰è®šæ•¸ï¼‰
            </p>
            <textarea id="pasteArea" rows="10" style="width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px; font-family: monospace; font-size: 12px;" placeholder='[{"commenter":"ç‹å°æ˜","content":"å¾ˆæ£’","time":"2025-11-19 10:00","likes":5}]'></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closePasteModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="importPastedData()">åŒ¯å…¥</button>
            </div>
        </div>
    </div>

    <script>
        // è³‡æ–™å„²å­˜
        let comments = [];
        let history = [];
        const MAX_HISTORY = 10;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            setupDragDrop();
            setupFileInput();
            setupSearch();
            loadFromLocalStorage();
        });
        
        // æ‹–æ”¾è¨­å®š
        function setupDragDrop() {
            const area = document.getElementById('uploadArea');
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file) handleFile(file);
            });
        }
        
        // æª”æ¡ˆé¸æ“‡è¨­å®š
        function setupFileInput() {
            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) handleFile(file);
            });
        }
        
        // è™•ç†æª”æ¡ˆ
        function handleFile(file) {
            const fileName = file.name.toLowerCase();
            
            if (fileName.endsWith('.csv')) {
                parseCSV(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                parseExcel(file);
            } else if (fileName.endsWith('.json')) {
                parseJSON(file);
            } else {
                showAlert('ä¸æ”¯æ´çš„æª”æ¡ˆæ ¼å¼ã€‚è«‹ä¸Šå‚³ CSVã€Excel æˆ– JSON æª”æ¡ˆã€‚', 'error');
            }
        }
        
        // è§£æ CSV
        function parseCSV(file) {
            Papa.parse(file, {
                header: true,
                encoding: 'UTF-8',
                complete: (results) => {
                    const data = results.data.filter(row => row.ç•™è¨€å…§å®¹ || row.content || row.message);
                    const normalized = data.map((row, index) => ({
                        id: Date.now() + index,
                        commenter: row.ç•™è¨€è€… || row.commenter || row.username || row.user || 'æœªçŸ¥ä½¿ç”¨è€…',
                        content: row.ç•™è¨€å…§å®¹ || row.content || row.message || row.text || '',
                        time: row.æ™‚é–“ || row.time || row.timestamp || row.created_time || new Date().toLocaleString('zh-TW'),
                        likes: parseInt(row.æŒ‰è®šæ•¸ || row.likes || row.like_count || 0),
                        source: file.name,
                        selected: false
                    }));
                    
                    importComments(normalized);
                    showAlert(`âœ… æˆåŠŸåŒ¯å…¥ ${normalized.length} å‰‡ç•™è¨€`, 'success');
                },
                error: () => {
                    showAlert('âŒ CSV è§£æå¤±æ•—ï¼Œè«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼', 'error');
                }
            });
        }
        
        // è§£æ Excel
        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    const normalized = jsonData.map((row, index) => ({
                        id: Date.now() + index,
                        commenter: row.ç•™è¨€è€… || row.commenter || row.username || 'æœªçŸ¥ä½¿ç”¨è€…',
                        content: row.ç•™è¨€å…§å®¹ || row.content || row.message || '',
                        time: row.æ™‚é–“ || row.time || row.timestamp || new Date().toLocaleString('zh-TW'),
                        likes: parseInt(row.æŒ‰è®šæ•¸ || row.likes || 0),
                        source: file.name,
                        selected: false
                    }));
                    
                    importComments(normalized);
                    showAlert(`âœ… æˆåŠŸåŒ¯å…¥ ${normalized.length} å‰‡ç•™è¨€ï¼ˆä¾†è‡ª Excelï¼‰`, 'success');
                } catch (error) {
                    showAlert('âŒ Excel è§£æå¤±æ•—ï¼š' + error.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // è§£æ JSON
        function parseJSON(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    const normalized = data.map((row, index) => ({
                        id: Date.now() + index,
                        commenter: row.commenter || row.username || row.user || 'æœªçŸ¥ä½¿ç”¨è€…',
                        content: row.content || row.message || row.text || '',
                        time: row.time || row.timestamp || row.created_time || new Date().toLocaleString('zh-TW'),
                        likes: parseInt(row.likes || row.like_count || 0),
                        source: file.name,
                        selected: false
                    }));
                    
                    importComments(normalized);
                    showAlert(`âœ… æˆåŠŸåŒ¯å…¥ ${normalized.length} å‰‡ç•™è¨€ï¼ˆä¾†è‡ª JSONï¼‰`, 'success');
                } catch (error) {
                    showAlert('âŒ JSON è§£æå¤±æ•—ï¼š' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // è¼‰å…¥ç¯„ä¾‹è³‡æ–™
        function loadSampleData() {
            const sampleComments = [
                { commenter: 'ç‹å°æ˜', content: 'é€™å€‹ç”¢å“çœŸçš„å¾ˆä¸éŒ¯ï¼ç”¨äº†ä¹‹å¾Œæ•ˆç‡æå‡å¾ˆå¤š ğŸ‘', time: '2025-11-18 10:30', likes: 15 },
                { commenter: 'æå°è¯', content: 'éå¸¸æ»¿æ„é€™æ¬¡çš„æœå‹™ï¼Œå®¢æœå›æ‡‰å¾ˆå¿«é€Ÿ', time: '2025-11-18 11:00', likes: 8 },
                { commenter: 'å¼µå¤§æ˜', content: 'å“è³ªå¾ˆå¥½ï¼Œåƒ¹æ ¼ä¹Ÿåˆç†ï¼Œæœƒæ¨è–¦çµ¦æœ‹å‹', time: '2025-11-18 12:00', likes: 12 },
                { commenter: 'é™³å°èŠ³', content: 'è«‹å•æœ‰å…¶ä»–é¡è‰²å¯ä»¥é¸æ“‡å—ï¼Ÿ', time: '2025-11-18 13:15', likes: 3 },
                { commenter: 'æ—å¿—æ˜', content: 'å‡ºè²¨é€Ÿåº¦å¾ˆå¿«ï¼ŒåŒ…è£ä¹Ÿå¾ˆä»”ç´°ï¼', time: '2025-11-18 14:20', likes: 6 },
                { commenter: 'Amy Chen', content: 'Great product! Highly recommended! ğŸŒŸ', time: '2025-11-18 15:30', likes: 20 },
                { commenter: 'é»ƒå°ç¾', content: 'ç”¨äº†ä¸€é€±ï¼Œæ•ˆæœç¬¦åˆé æœŸï¼Œè®šï¼', time: '2025-11-18 16:45', likes: 9 },
                { commenter: 'å³å¤§å‹‡', content: 'æœ‰é»å°è²´ï¼Œä½†ç‰©è¶…æ‰€å€¼', time: '2025-11-19 09:00', likes: 4 },
                { commenter: 'åŠ‰å°å©·', content: 'ç¬¬äºŒæ¬¡è³¼è²·äº†ï¼Œå“è³ªç©©å®š', time: '2025-11-19 10:00', likes: 7 },
                { commenter: 'John Lee', content: 'Customer service is excellent! ğŸ‘', time: '2025-11-19 11:00', likes: 11 }
            ];
            
            const normalized = sampleComments.map((c, i) => ({
                id: Date.now() + i,
                commenter: c.commenter,
                content: c.content,
                time: c.time,
                likes: c.likes,
                source: 'ç¯„ä¾‹è³‡æ–™',
                selected: false
            }));
            
            importComments(normalized);
            showAlert('âœ¨ å·²è¼‰å…¥ 10 å‰‡ç¯„ä¾‹ç•™è¨€ï¼Œæ‚¨å¯ä»¥ç«‹å³é–‹å§‹ç·¨è¼¯å’ŒåŒ¯å‡ºï¼', 'success');
        }
        
        // åŒ¯å…¥ç•™è¨€
        function importComments(data) {
            saveHistory();
            comments = data;
            renderTable();
            updateStats();
            saveToLocalStorage();
            document.getElementById('toolbar').style.display = 'flex';
            document.getElementById('tableContainer').style.display = 'block';
            document.getElementById('stats').style.display = 'flex';
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(filteredComments = null) {
            const tbody = document.getElementById('commentsBody');
            const data = filteredComments || comments;
            
            tbody.innerHTML = data.map(comment => `
                <tr data-id="${comment.id}">
                    <td><input type="checkbox" class="checkbox" ${comment.selected ? 'checked' : ''} onchange="toggleSelect(${comment.id})"></td>
                    <td contenteditable="true" class="editable" onblur="updateComment(${comment.id}, 'commenter', this.innerText)">${comment.commenter}</td>
                    <td contenteditable="true" class="editable" onblur="updateComment(${comment.id}, 'content', this.innerText)">${comment.content}</td>
                    <td contenteditable="true" class="editable" onblur="updateComment(${comment.id}, 'time', this.innerText)">${comment.time}</td>
                    <td contenteditable="true" class="editable" onblur="updateComment(${comment.id}, 'likes', parseInt(this.innerText))">${comment.likes}</td>
                    <td>${comment.source}</td>
                </tr>
            `).join('');
            
            updateStats(data);
        }
        
        // æ›´æ–°ç•™è¨€
        function updateComment(id, field, value) {
            saveHistory();
            const comment = comments.find(c => c.id === id);
            if (comment) {
                comment[field] = value;
                saveToLocalStorage();
                showAlert('âœ… å·²å„²å­˜', 'success', 1000);
            }
        }
        
        // åˆ‡æ›é¸å–
        function toggleSelect(id) {
            const comment = comments.find(c => c.id === id);
            if (comment) {
                comment.selected = !comment.selected;
                updateStats();
            }
        }
        
        // å…¨é¸/å–æ¶ˆå…¨é¸
        function toggleSelectAll() {
            const checked = document.getElementById('selectAll').checked;
            comments.forEach(c => c.selected = checked);
            renderTable();
        }
        
        // åˆªé™¤é¸å–
        function deleteSelected() {
            const selectedCount = comments.filter(c => c.selected).length;
            if (selectedCount === 0) {
                showAlert('è«‹å…ˆé¸å–è¦åˆªé™¤çš„ç•™è¨€', 'error');
                return;
            }
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedCount} å‰‡ç•™è¨€å—ï¼Ÿ`)) {
                saveHistory();
                comments = comments.filter(c => !c.selected);
                renderTable();
                saveToLocalStorage();
                showAlert(`âœ… å·²åˆªé™¤ ${selectedCount} å‰‡ç•™è¨€`, 'success');
            }
        }
        
        // æœå°‹
        function setupSearch() {
            document.getElementById('searchBox')?.addEventListener('input', (e) => {
                const keyword = e.target.value.toLowerCase();
                if (!keyword) {
                    renderTable();
                    return;
                }
                
                const filtered = comments.filter(c => 
                    c.content.toLowerCase().includes(keyword) ||
                    c.commenter.toLowerCase().includes(keyword)
                );
                renderTable(filtered);
            });
        }
        
        // å¾©åŸ
        function undo() {
            if (history.length === 0) {
                showAlert('æ²’æœ‰å¯å¾©åŸçš„æ“ä½œ', 'error');
                return;
            }
            
            comments = history.pop();
            renderTable();
            saveToLocalStorage();
            showAlert('â†¶ å·²å¾©åŸ', 'success', 1000);
        }
        
        // å„²å­˜æ­·å²
        function saveHistory() {
            history.push(JSON.parse(JSON.stringify(comments)));
            if (history.length > MAX_HISTORY) {
                history.shift();
            }
        }
        
        // åŒ¯å‡º Excel
        function exportToExcel() {
            if (comments.length === 0) {
                showAlert('æ²’æœ‰è³‡æ–™å¯ä»¥åŒ¯å‡º', 'error');
                return;
            }
            
            const exportData = comments.map(c => ({
                'ç•™è¨€è€…': c.commenter,
                'ç•™è¨€å…§å®¹': c.content,
                'æ™‚é–“': c.time,
                'æŒ‰è®šæ•¸': c.likes,
                'ä¾†æº': c.source
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ç•™è¨€è³‡æ–™');
            
            // è¨­å®šæ¬„ä½å¯¬åº¦
            ws['!cols'] = [
                { wch: 15 },  // ç•™è¨€è€…
                { wch: 50 },  // ç•™è¨€å…§å®¹
                { wch: 20 },  // æ™‚é–“
                { wch: 10 },  // æŒ‰è®šæ•¸
                { wch: 15 }   // ä¾†æº
            ];
            
            const timestamp = new Date().toISOString().slice(0,16).replace('T', '_').replace(/:/g, '');
            XLSX.writeFile(wb, `ç•™è¨€è³‡æ–™_${timestamp}.xlsx`);
            
            showAlert('ğŸ“¥ Excel æª”æ¡ˆå·²ä¸‹è¼‰', 'success');
        }
        
        // æ›´æ–°çµ±è¨ˆ
        function updateStats(displayData = null) {
            const data = displayData || comments;
            document.getElementById('totalCount').textContent = comments.length;
            document.getElementById('displayCount').textContent = data.length;
            document.getElementById('selectedCount').textContent = comments.filter(c => c.selected).length;
        }
        
        // é¡¯ç¤ºæç¤º
        function showAlert(message, type = 'success', duration = 3000) {
            const alertArea = document.getElementById('alertArea');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertArea.appendChild(alert);
            
            setTimeout(() => alert.remove(), duration);
        }
        
        // Modal æ§åˆ¶
        function showPasteModal() {
            document.getElementById('pasteModal').classList.add('show');
        }
        
        function closePasteModal() {
            document.getElementById('pasteModal').classList.remove('show');
        }
        
        // åŒ¯å…¥è²¼ä¸Šçš„è³‡æ–™
        function importPastedData() {
            const text = document.getElementById('pasteArea').value.trim();
            if (!text) return;
            
            try {
                // å˜—è©¦ JSON
                const data = JSON.parse(text);
                const normalized = data.map((row, index) => ({
                    id: Date.now() + index,
                    commenter: row.commenter || row.username || 'æœªçŸ¥',
                    content: row.content || row.message || '',
                    time: row.time || row.timestamp || new Date().toLocaleString('zh-TW'),
                    likes: parseInt(row.likes || 0),
                    source: 'æ‰‹å‹•è²¼ä¸Š',
                    selected: false
                }));
                
                importComments(normalized);
                closePasteModal();
                showAlert(`âœ… æˆåŠŸåŒ¯å…¥ ${normalized.length} å‰‡ç•™è¨€`, 'success');
            } catch (e) {
                // å˜—è©¦ CSV æ–‡å­—
                Papa.parse(text, {
                    header: true,
                    complete: (results) => {
                        const normalized = results.data.map((row, index) => ({
                            id: Date.now() + index,
                            commenter: row.ç•™è¨€è€… || row.commenter || 'æœªçŸ¥',
                            content: row.ç•™è¨€å…§å®¹ || row.content || '',
                            time: row.æ™‚é–“ || row.time || new Date().toLocaleString('zh-TW'),
                            likes: parseInt(row.æŒ‰è®šæ•¸ || row.likes || 0),
                            source: 'æ‰‹å‹•è²¼ä¸Š',
                            selected: false
                        }));
                        
                        importComments(normalized);
                        closePasteModal();
                        showAlert(`âœ… æˆåŠŸåŒ¯å…¥ ${normalized.length} å‰‡ç•™è¨€`, 'success');
                    }
                });
            }
        }
        
        // æ¸…é™¤å…¨éƒ¨
        function clearAll() {
            if (comments.length === 0) return;
            
            if (confirm(`ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨ ${comments.length} å‰‡ç•™è¨€å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚`)) {
                saveHistory();
                comments = [];
                renderTable();
                saveToLocalStorage();
                document.getElementById('toolbar').style.display = 'none';
                document.getElementById('tableContainer').style.display = 'none';
                document.getElementById('stats').style.display = 'none';
                showAlert('ğŸ”„ å·²æ¸…é™¤æ‰€æœ‰è³‡æ–™', 'success');
            }
        }
        
        // LocalStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('comments', JSON.stringify(comments));
            } catch (e) {
                showAlert('âš ï¸ å„²å­˜å¤±æ•—ï¼šå„²å­˜ç©ºé–“å¯èƒ½ä¸è¶³', 'error');
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('comments');
                if (saved) {
                    comments = JSON.parse(saved);
                    if (comments.length > 0) {
                        renderTable();
                        document.getElementById('toolbar').style.display = 'flex';
                        document.getElementById('tableContainer').style.display = 'block';
                        document.getElementById('stats').style.display = 'flex';
                        showAlert(`âœ… å·²è¼‰å…¥ ${comments.length} å‰‡ç•™è¨€ï¼ˆä¾†è‡ªä¸Šæ¬¡å·¥ä½œéšæ®µï¼‰`, 'success');
                    }
                }
            } catch (e) {
                console.error('è¼‰å…¥å¤±æ•—', e);
            }
        }
        
        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', (e) => {
            // Ctrl+Z å¾©åŸ
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            // Ctrl+S å„²å­˜ï¼ˆå¯¦éš›ä¸Šè‡ªå‹•å„²å­˜ï¼‰
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToLocalStorage();
                showAlert('ğŸ’¾ å·²å„²å­˜', 'success', 1000);
            }
        });
    </script>
</body>
</html>
