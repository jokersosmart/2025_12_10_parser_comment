<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram ç•™è¨€çˆ¬èŸ²å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .step {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 6px;
        }
        
        .step-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #667eea;
        }
        
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-info {
            background: #0ea5e9;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 6px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        
        .hidden {
            display: none;
        }
        
        .progress {
            background: #e5e7eb;
            border-radius: 6px;
            height: 30px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        
        .results-container {
            margin-top: 30px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .comments-display {
            max-height: 600px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 20px;
            background: white;
        }
        
        .comment-item {
            padding: 15px;
            border-bottom: 1px solid #f1f3f5;
            cursor: pointer;
        }
        
        .comment-item:hover {
            background: #f8f9fa;
        }
        
        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .commenter {
            font-weight: bold;
            color: #495057;
        }
        
        .comment-meta {
            font-size: 12px;
            color: #6c757d;
        }
        
        .comment-content {
            color: #212529;
            line-height: 1.5;
            margin-bottom: 8px;
        }
        
        .comment-stats {
            font-size: 12px;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .copy-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¸ Instagram ç•™è¨€çˆ¬èŸ²å·¥å…·</h1>
            <p>è¼¸å…¥Token â†’ é©—è­‰ â†’ é¸æ“‡çˆ¬å–æ–¹å¼ â†’ æŸ¥çœ‹çµæœ â†’ è¤‡è£½æˆ–åŒ¯å‡º</p>
        </div>
        
        <div class="content">
            <!-- æ­¥é©Ÿ1: è¼¸å…¥Token -->
            <div class="step" id="step1">
                <div class="step-title">æ­¥é©Ÿ 1ï¸âƒ£: è¼¸å…¥æ‚¨çš„ Instagram API Token</div>
                <div id="tokenAlert"></div>
                <div class="input-group">
                    <label>Instagram Access Tokenï¼ˆå¯å¾Metaé–‹ç™¼è€…å¹³å°å–å¾—ï¼‰</label>
                    <input type="text" id="tokenInput" placeholder="è²¼ä¸Šæ‚¨çš„Instagram Token...">
                    <small style="color: #6c757d; display: block; margin-top: 5px;">
                        ğŸ’¡ æç¤ºï¼šé€™å€‹Tokenæœƒæš«å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒå‚³é€åˆ°ä»»ä½•ä¼ºæœå™¨
                    </small>
                </div>
                <button class="btn btn-primary" onclick="verifyToken()">ğŸ” é©—è­‰Token</button>
                <button class="btn btn-secondary" onclick="showTokenHelp()">â“ å¦‚ä½•å–å¾—Token</button>
            </div>
            
            <!-- æ­¥é©Ÿ2: é¸æ“‡çˆ¬å–æ¨¡å¼ -->
            <div class="step hidden" id="step2">
                <div class="step-title">æ­¥é©Ÿ 2ï¸âƒ£: é¸æ“‡çˆ¬å–æ¨¡å¼</div>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="mode" value="post" checked>
                        ç‰¹å®šæ–‡ç« æ¨¡å¼ï¼ˆçˆ¬å–å–®ä¸€è²¼æ–‡çš„ç•™è¨€ï¼‰
                    </label>
                    <label>
                        <input type="radio" name="mode" value="account">
                        å¸³è™Ÿæ‰¹æ¬¡æ¨¡å¼ï¼ˆçˆ¬å–å¸³è™Ÿä¸‹å¤šå€‹è²¼æ–‡çš„ç•™è¨€ï¼‰
                    </label>
                </div>
                
                <div id="postMode">
                    <div class="input-group">
                        <label>Instagram è²¼æ–‡ç¶²å€</label>
                        <input type="text" id="postUrl" placeholder="ä¾‹å¦‚ï¼šhttps://www.instagram.com/p/ABC123/">
                    </div>
                </div>
                
                <div id="accountMode" class="hidden">
                    <div class="input-group">
                        <label>Instagram å¸³è™Ÿç¶²å€æˆ–ç”¨æˆ¶ID</label>
                        <input type="text" id="accountInput" placeholder="ä¾‹å¦‚ï¼šhttps://www.instagram.com/ssh.ado æˆ– 33130167256574519">
                    </div>
                    <div class="input-group">
                        <label>çˆ¬å–å¹¾å€‹æœ€æ–°è²¼æ–‡</label>
                        <select id="postLimit">
                            <option value="5">5å€‹è²¼æ–‡</option>
                            <option value="10" selected>10å€‹è²¼æ–‡</option>
                            <option value="20">20å€‹è²¼æ–‡</option>
                            <option value="50">50å€‹è²¼æ–‡</option>
                        </select>
                    </div>
                </div>
                
                <button class="btn btn-success" onclick="startScraping()">ğŸš€ é–‹å§‹çˆ¬å–</button>
            </div>
            
            <!-- æ­¥é©Ÿ3: çˆ¬å–é€²åº¦ -->
            <div class="step hidden" id="step3">
                <div class="step-title">æ­¥é©Ÿ 3ï¸âƒ£: çˆ¬å–é€²åº¦</div>
                <div id="progressInfo"></div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                </div>
                <div id="progressDetails"></div>
            </div>
            
            <!-- æ­¥é©Ÿ4: é¡¯ç¤ºçµæœ -->
            <div class="results-container hidden" id="step4">
                <div class="step">
                    <div class="step-title">æ­¥é©Ÿ 4ï¸âƒ£: çˆ¬å–çµæœ</div>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalComments">0</div>
                            <div class="stat-label">ç¸½ç•™è¨€æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalPosts">0</div>
                            <div class="stat-label">è™•ç†è²¼æ–‡æ•¸</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="scrapeTime">0</div>
                            <div class="stat-label">è™•ç†æ™‚é–“ï¼ˆç§’ï¼‰</div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0;">
                        <button class="btn btn-success" onclick="exportToExcel()">ğŸ“¥ åŒ¯å‡ºç‚ºExcel</button>
                        <button class="btn btn-info" onclick="copyAllComments()">ğŸ“‹ è¤‡è£½æ‰€æœ‰ç•™è¨€</button>
                        <button class="btn btn-secondary" onclick="reset()">ğŸ”„ é‡æ–°é–‹å§‹</button>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" id="searchBox" placeholder="ğŸ” æœå°‹ç•™è¨€å…§å®¹..." onkeyup="filterComments()">
                    </div>
                    
                    <div class="comments-display" id="commentsDisplay"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentToken = '';
        let allComments = [];
        let startTime = 0;
        
        // ç›£è½æ¨¡å¼åˆ‡æ›
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                if (e.target.value === 'post') {
                    document.getElementById('postMode').classList.remove('hidden');
                    document.getElementById('accountMode').classList.add('hidden');
                } else {
                    document.getElementById('postMode').classList.add('hidden');
                    document.getElementById('accountMode').classList.remove('hidden');
                }
            });
        });
        
        // æ­¥é©Ÿ1: é©—è­‰Token
        async function verifyToken() {
            const token = document.getElementById('tokenInput').value.trim();
            const alertDiv = document.getElementById('tokenAlert');
            
            if (!token) {
                alertDiv.innerHTML = '<div class="alert alert-error">âš ï¸ è«‹è¼¸å…¥Token</div>';
                return;
            }
            
            alertDiv.innerHTML = '<div class="alert alert-info">ğŸ” æ­£åœ¨é©—è­‰Token...</div>';
            
            try {
                // æ¸¬è©¦Token
                const response = await fetch(`https://graph.facebook.com/v18.0/me?access_token=${token}`);
                const data = await response.json();
                
                if (data.error) {
                    alertDiv.innerHTML = `<div class="alert alert-error">âŒ Tokenç„¡æ•ˆï¼š${data.error.message}<br><small>éŒ¯èª¤ä»£ç¢¼ï¼š${data.error.code}</small></div>`;
                    return;
                }
                
                // Tokenæœ‰æ•ˆ
                currentToken = token;
                localStorage.setItem('ig_token', token);
                
                alertDiv.innerHTML = `<div class="alert alert-success">âœ… Tokené©—è­‰æˆåŠŸï¼<br>å¸³è™ŸIDï¼š${data.id}${data.username ? ' | ä½¿ç”¨è€…åç¨±ï¼š' + data.username : ''}</div>`;
                
                // é¡¯ç¤ºæ­¥é©Ÿ2
                document.getElementById('step2').classList.remove('hidden');
                
            } catch (error) {
                alertDiv.innerHTML = `<div class="alert alert-error">âŒ é©—è­‰å¤±æ•—ï¼š${error.message}</div>`;
            }
        }
        
        // é¡¯ç¤ºTokenå–å¾—èªªæ˜
        function showTokenHelp() {
            alert(`å¦‚ä½•å–å¾—Instagram Tokenï¼š

æ–¹æ³•1: Graph API Explorerï¼ˆæ¨è–¦ï¼‰
1. å‰å¾€ï¼šhttps://developers.facebook.com/tools/explorer/
2. é¸æ“‡æ‚¨çš„æ‡‰ç”¨ç¨‹å¼
3. é»æ“Šã€ŒGet Tokenã€â†’ã€ŒGet User Access Tokenã€
4. å‹¾é¸instagram_basicæ¬Šé™
5. è¤‡è£½Token

æ–¹æ³•2: ä½¿ç”¨æ‚¨æä¾›çš„Token
å¦‚æœæ‚¨å·²æœ‰Tokenï¼Œç›´æ¥è²¼ä¸Šå³å¯ã€‚

æ³¨æ„ï¼šTokenå¿…é ˆæœ‰instagram_basicæ¬Šé™æ‰èƒ½ä½¿ç”¨ã€‚`);
        }
        
        // æ­¥é©Ÿ2: é–‹å§‹çˆ¬å–
        async function startScraping() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            
            document.getElementById('step3').classList.remove('hidden');
            startTime = Date.now();
            
            if (mode === 'post') {
                await scrapePost();
            } else {
                await scrapeAccount();
            }
        }
        
        // çˆ¬å–å–®ä¸€è²¼æ–‡
        async function scrapePost() {
            const postUrl = document.getElementById('postUrl').value.trim();
            
            if (!postUrl) {
                alert('è«‹è¼¸å…¥è²¼æ–‡ç¶²å€');
                return;
            }
            
            // è§£æmedia ID
            const mediaId = parseMediaId(postUrl);
            if (!mediaId) {
                alert('ç„¡æ³•è§£æè²¼æ–‡ç¶²å€ï¼Œè«‹ç¢ºèªæ ¼å¼æ­£ç¢º');
                return;
            }
            
            updateProgress(10, 'æ­£åœ¨å–å¾—è²¼æ–‡è³‡è¨Š...');
            
            try {
                const comments = await fetchComments(mediaId);
                displayResults(comments, [{ id: mediaId, url: postUrl }]);
            } catch (error) {
                showError(error.message);
            }
        }
        
        // çˆ¬å–å¸³è™Ÿ
        async function scrapeAccount() {
            const accountInput = document.getElementById('accountInput').value.trim();
            const postLimit = parseInt(document.getElementById('postLimit').value);
            
            if (!accountInput) {
                alert('è«‹è¼¸å…¥å¸³è™Ÿç¶²å€æˆ–ç”¨æˆ¶ID');
                return;
            }
            
            let userId = accountInput;
            if (accountInput.includes('instagram.com')) {
                userId = parseUsername(accountInput);
            }
            
            updateProgress(5, 'æ­£åœ¨å–å¾—å¸³è™Ÿè³‡è¨Š...');
            
            try {
                // å–å¾—å¸³è™Ÿçš„è²¼æ–‡åˆ—è¡¨
                updateProgress(10, `æ­£åœ¨å–å¾—æœ€è¿‘${postLimit}å€‹è²¼æ–‡...`);
                const posts = await fetchUserMedia(userId, postLimit);
                
                if (posts.length === 0) {
                    showError('æ‰¾ä¸åˆ°è²¼æ–‡æˆ–å¸³è™Ÿä¸å­˜åœ¨');
                    return;
                }
                
                // å°æ¯å€‹è²¼æ–‡æŠ“å–ç•™è¨€
                allComments = [];
                for (let i = 0; i < posts.length; i++) {
                    const post = posts[i];
                    const progress = 10 + (i / posts.length) * 80;
                    updateProgress(progress, `æ­£åœ¨è™•ç†ç¬¬ ${i+1}/${posts.length} å€‹è²¼æ–‡...`);
                    
                    const comments = await fetchComments(post.id);
                    comments.forEach(c => {
                        c.sourcePost = post;
                        allComments.push(c);
                    });
                    
                    // é¿å…è§¸ç™¼é€Ÿç‡é™åˆ¶
                    await sleep(500);
                }
                
                updateProgress(100, 'å®Œæˆï¼');
                displayResults(allComments, posts);
                
            } catch (error) {
                showError(error.message);
            }
        }
        
        // å–å¾—ç”¨æˆ¶çš„è²¼æ–‡åˆ—è¡¨
        async function fetchUserMedia(userId, limit) {
            const url = `https://graph.facebook.com/v18.0/${userId}/media?fields=id,caption,timestamp,permalink&limit=${limit}&access_token=${currentToken}`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message);
            }
            
            return data.data || [];
        }
        
        // å–å¾—è²¼æ–‡ç•™è¨€
        async function fetchComments(mediaId) {
            const comments = [];
            let nextUrl = `https://graph.facebook.com/v18.0/${mediaId}/comments?fields=id,username,text,timestamp,like_count&limit=50&access_token=${currentToken}`;
            
            while (nextUrl) {
                const response = await fetch(nextUrl);
                const data = await response.json();
                
                if (data.error) {
                    // å¦‚æœæ²’æœ‰ç•™è¨€æˆ–ç„¡æ¬Šé™ï¼Œè¿”å›ç©ºé™£åˆ—
                    if (data.error.code === 100) {
                        break;
                    }
                    throw new Error(data.error.message);
                }
                
                if (data.data) {
                    comments.push(...data.data);
                }
                
                nextUrl = data.paging?.next || null;
                
                // é¿å…éå¿«è«‹æ±‚
                if (nextUrl) await sleep(200);
            }
            
            return comments;
        }
        
        // è§£æMedia ID
        function parseMediaId(url) {
            const match = url.match(/instagram\.com\/p\/([A-Za-z0-9_-]+)/);
            return match ? match[1] : null;
        }
        
        // è§£æUsername
        function parseUsername(url) {
            const match = url.match(/instagram\.com\/([A-Za-z0-9._]+)/);
            return match ? match[1] : null;
        }
        
        // æ›´æ–°é€²åº¦
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressBar').textContent = Math.round(percent) + '%';
            document.getElementById('progressDetails').innerHTML = `<p style="text-align: center; color: #6c757d; margin-top: 10px;">${text}</p>`;
        }
        
        // é¡¯ç¤ºçµæœ
        function displayResults(comments, posts) {
            const endTime = Date.now();
            const duration = ((endTime - startTime) / 1000).toFixed(1);
            
            document.getElementById('step4').classList.remove('hidden');
            document.getElementById('totalComments').textContent = comments.length;
            document.getElementById('totalPosts').textContent = posts.length;
            document.getElementById('scrapeTime').textContent = duration;
            
            allComments = comments;
            renderComments(comments);
        }
        
        // æ¸²æŸ“ç•™è¨€
        function renderComments(comments) {
            const display = document.getElementById('commentsDisplay');
            
            if (comments.length === 0) {
                display.innerHTML = '<p style="text-align: center; color: #6c757d; padding: 40px;">æ²’æœ‰ç•™è¨€è³‡æ–™</p>';
                return;
            }
            
            display.innerHTML = comments.map((c, index) => `
                <div class="comment-item" id="comment-${index}">
                    <div class="comment-header">
                        <span class="commenter">@${c.username || 'æœªçŸ¥ä½¿ç”¨è€…'}</span>
                        <span class="comment-meta">
                            ${formatDate(c.timestamp)}
                            <button class="copy-btn" onclick="copyComment(${index})">è¤‡è£½</button>
                        </span>
                    </div>
                    <div class="comment-content">${c.text || c.content || ''}</div>
                    <div class="comment-stats">
                        ğŸ‘ ${c.like_count || 0} å€‹è®š
                        ${c.sourcePost ? ` | ä¾†æºï¼š<a href="${c.sourcePost.permalink || '#'}" target="_blank">è²¼æ–‡ ${comments.filter(x => x.sourcePost?.id === c.sourcePost.id).indexOf(c) + 1}</a>` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        // ç¯©é¸ç•™è¨€
        function filterComments() {
            const keyword = document.getElementById('searchBox').value.toLowerCase();
            if (!keyword) {
                renderComments(allComments);
                return;
            }
            
            const filtered = allComments.filter(c => 
                (c.text && c.text.toLowerCase().includes(keyword)) ||
                (c.username && c.username.toLowerCase().includes(keyword))
            );
            renderComments(filtered);
        }
        
        // è¤‡è£½å–®å‰‡ç•™è¨€
        function copyComment(index) {
            const comment = allComments[index];
            const text = `@${comment.username}\n${comment.text}\næ™‚é–“ï¼š${formatDate(comment.timestamp)}\næŒ‰è®šï¼š${comment.like_count || 0}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showAlert('âœ… å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success', 2000);
            });
        }
        
        // è¤‡è£½æ‰€æœ‰ç•™è¨€
        function copyAllComments() {
            if (allComments.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯è¤‡è£½');
                return;
            }
            
            const text = allComments.map(c => 
                `@${c.username}\t${c.text}\t${formatDate(c.timestamp)}\t${c.like_count || 0}`
            ).join('\n');
            
            const header = 'ç•™è¨€è€…\tç•™è¨€å…§å®¹\tæ™‚é–“\tæŒ‰è®šæ•¸\n';
            
            navigator.clipboard.writeText(header + text).then(() => {
                showAlert(`âœ… å·²è¤‡è£½ ${allComments.length} å‰‡ç•™è¨€åˆ°å‰ªè²¼ç°¿ï¼ˆTabåˆ†éš”ï¼Œå¯ç›´æ¥è²¼åˆ°Excelï¼‰`, 'success', 3000);
            });
        }
        
        // åŒ¯å‡ºExcel
        function exportToExcel() {
            if (allComments.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }
            
            const exportData = allComments.map(c => ({
                'ç•™è¨€è€…': c.username || 'æœªçŸ¥',
                'ç•™è¨€å…§å®¹': c.text || '',
                'æ™‚é–“': formatDate(c.timestamp),
                'æŒ‰è®šæ•¸': c.like_count || 0,
                'ä¾†æºè²¼æ–‡': c.sourcePost?.permalink || ''
            }));
            
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ç•™è¨€è³‡æ–™');
            
            ws['!cols'] = [
                { wch: 20 },
                { wch: 50 },
                { wch: 20 },
                { wch: 10 },
                { wch: 40 }
            ];
            
            const timestamp = new Date().toISOString().slice(0,16).replace('T', '_').replace(/:/g, '');
            XLSX.writeFile(wb, `Instagramç•™è¨€_${timestamp}.xlsx`);
            
            showAlert('ğŸ“¥ Excelæª”æ¡ˆå·²ä¸‹è¼‰', 'success');
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // é¡¯ç¤ºéŒ¯èª¤
        function showError(message) {
            document.getElementById('progressDetails').innerHTML = `<div class="alert alert-error">âŒ ${message}</div>`;
        }
        
        // é¡¯ç¤ºæç¤º
        function showAlert(message, type, duration = 3000) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alert.style.position = 'fixed';
            alert.style.top = '20px';
            alert.style.right = '20px';
            alert.style.zIndex = '9999';
            alert.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), duration);
        }
        
        // é‡ç½®
        function reset() {
            if (confirm('ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿé€™æœƒæ¸…é™¤ç•¶å‰çµæœã€‚')) {
                allComments = [];
                document.getElementById('step3').classList.add('hidden');
                document.getElementById('step4').classList.add('hidden');
                document.getElementById('progressBar').style.width = '0%';
            }
        }
        
        // å»¶é²
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // è¼‰å…¥å„²å­˜çš„Token
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('ig_token');
            if (saved) {
                document.getElementById('tokenInput').value = saved;
                showAlert('ğŸ’¡ å·²è¼‰å…¥ä¸Šæ¬¡ä½¿ç”¨çš„Token', 'info', 2000);
            }
        });
    </script>
</body>
</html>
